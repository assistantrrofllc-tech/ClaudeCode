name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            echo "Fixing permissions..."
            chown -R crewledger:crewledger /opt/crewledger/

            echo "Pulling latest code..."
            cd /opt/crewledger
            su -s /bin/bash crewledger -c 'git fetch origin main && git reset --hard origin/main'

            echo "Installing dependencies..."
            source /opt/crewledger/venv/bin/activate
            pip install -r /opt/crewledger/requirements.txt -q

            echo "Restarting service..."
            systemctl restart crewledger

            echo "Health check..."
            sleep 3
            if curl -sf http://127.0.0.1:5000/health | grep -q '"ok"'; then
              echo "Deploy successful!"
            else
              echo "Health check FAILED"
              journalctl -u crewledger -n 20 --no-pager
              exit 1
            fi

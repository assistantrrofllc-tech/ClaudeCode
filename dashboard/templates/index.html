{% extends "base.html" %}
{% block title %}CrewLedger â€” Dashboard{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-row">
    <div class="stat-card">
        <div class="stat-value">${{ "%.2f"|format(stats.week_spend) }}</div>
        <div class="stat-label">This Week</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">${{ "%.2f"|format(stats.month_spend) }}</div>
        <div class="stat-label">This Month</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_receipts }}</div>
        <div class="stat-label">Total Receipts</div>
    </div>
    <div class="stat-card stat-card--alert {% if stats.flagged_count > 0 %}has-flags{% endif %}">
        <div class="stat-value">{{ stats.flagged_count }}</div>
        <div class="stat-label">Flagged</div>
    </div>
</div>

<!-- Flagged Receipts Queue -->
{% if flagged %}
<section class="section">
    <div class="section-header">
        <h2>Flagged Receipts</h2>
        <span class="badge badge--red">{{ flagged|length }}</span>
    </div>
    <div class="receipt-list">
        {% for r in flagged %}
        <div class="receipt-row receipt-row--flagged" onclick="openReceiptModal({{ r.id }})">
            <div class="receipt-row-main">
                <div class="receipt-icon">
                    {% if r.image_url %}
                    <button class="img-btn" onclick="event.stopPropagation(); openReceiptModal({{ r.id }})" title="View receipt image">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
                    </button>
                    {% else %}
                    <span class="no-img">--</span>
                    {% endif %}
                </div>
                <div class="receipt-info">
                    <div class="receipt-vendor">{{ r.vendor_name or 'Unknown' }}</div>
                    <div class="receipt-meta">{{ r.employee_name or '?' }} &middot; {{ r.flag_reason or 'Flagged' }}</div>
                </div>
                <div class="receipt-amount">${{ "%.2f"|format(r.total or 0) }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Recent Activity -->
<section class="section">
    <div class="section-header">
        <h2>Recent Activity</h2>
        <a href="/ledger" class="link">View all</a>
    </div>
    <div class="receipt-list">
        {% for r in recent %}
        <div class="receipt-row" onclick="openReceiptModal({{ r.id }})">
            <div class="receipt-row-main">
                <div class="receipt-icon">
                    {% if r.image_url %}
                    <button class="img-btn" onclick="event.stopPropagation(); openReceiptModal({{ r.id }})" title="View receipt image">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
                    </button>
                    {% else %}
                    <span class="no-img">--</span>
                    {% endif %}
                </div>
                <div class="receipt-info">
                    <div class="receipt-vendor">{{ r.vendor_name or 'Unknown' }}</div>
                    <div class="receipt-meta">
                        {{ r.employee_name or '?' }}
                        {% if r.project_name %}&middot; {{ r.project_name }}{% endif %}
                        {% if r.purchase_date %}&middot; {{ r.purchase_date }}{% endif %}
                    </div>
                </div>
                <div class="receipt-right">
                    <div class="receipt-amount">${{ "%.2f"|format(r.total or 0) }}</div>
                    <span class="badge badge--{{ r.status }}">{{ r.status }}</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block pre_scripts %}
<script>var CAN_EDIT = {{ can_edit | tojson }};</script>
{% endblock %}

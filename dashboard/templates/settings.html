{% extends "base.html" %}
{% set active_page = "settings" %}
{% block title %}CrewLedger — Settings{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Settings</h1>
</div>

<!-- Quick Links -->
<div class="settings-links">
    <a href="/employees" class="settings-link-card">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        <div>
            <strong>Employee Management</strong>
            <span>Add, edit, deactivate employees</span>
        </div>
    </a>
</div>

<!-- Projects Section -->
<section class="settings-section">
    <div class="section-header" style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Projects</h2>
        <button class="btn btn--small btn--primary" onclick="showAddProject()">+ Add Project</button>
    </div>

    <!-- Add Project Form (hidden) -->
    <div id="add-project-form" class="card" style="display:none; margin-bottom:16px;">
        <h3>Add New Project</h3>
        <form onsubmit="addProject(event)">
            <div class="form-row">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" id="proj-name" required placeholder="Sparrow">
                </div>
                <div class="form-group">
                    <label>Project Code</label>
                    <input type="text" id="proj-code" placeholder="SPR-001">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="proj-address" placeholder="123 Main St">
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="proj-city" placeholder="Kissimmee">
                </div>
                <div class="form-group">
                    <label>State</label>
                    <input type="text" id="proj-state" placeholder="FL" maxlength="2">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Status</label>
                    <select id="proj-status">
                        <option value="active">Active</option>
                        <option value="on_hold">On Hold</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="proj-start">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="proj-end">
                </div>
            </div>
            <div class="form-row" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="proj-notes" rows="2" placeholder="Project notes..."></textarea>
                </div>
            </div>
            <div style="display:flex; gap:8px; margin-top:8px;">
                <button type="submit" class="btn btn--primary">Save Project</button>
                <button type="button" class="btn btn--secondary" onclick="hideAddProject()">Cancel</button>
            </div>
            <div id="proj-error" class="error-msg" style="display:none;"></div>
        </form>
    </div>

    <!-- Project List -->
    <div class="card">
        <table class="data-table" id="proj-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Code</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Receipts</th>
                    <th>Spend</th>
                </tr>
            </thead>
            <tbody>
                {% for p in projects %}
                <tr>
                    <td><strong>{{ p.name }}</strong></td>
                    <td class="text-muted">{{ p.project_code or '—' }}</td>
                    <td class="text-muted">{% if p.city %}{{ p.city }}{% if p.state %}, {{ p.state }}{% endif %}{% else %}—{% endif %}</td>
                    <td>
                        {% if p.status == 'active' %}
                        <span class="badge badge--confirmed">Active</span>
                        {% elif p.status == 'on_hold' %}
                        <span class="badge badge--pending">On Hold</span>
                        {% else %}
                        <span class="badge badge--rejected">Completed</span>
                        {% endif %}
                    </td>
                    <td>{{ p.receipt_count or 0 }}</td>
                    <td>${{ "%.2f"|format(p.total_spend or 0) }}</td>
                </tr>
                {% endfor %}
                {% if not projects %}
                <tr><td colspan="6" class="text-muted" style="text-align:center;">No projects yet</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</section>

<!-- Email Report Settings -->
<section class="settings-section">
    <h2>Email Reports</h2>
    <div class="card" style="max-width: 640px;">
        <form id="settings-form" onsubmit="saveSettings(event)">
            <!-- Enable/Disable -->
            <div class="form-row" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Email Reports</label>
                    <select id="set-enabled">
                        <option value="1" {% if settings.get('enabled') == '1' %}selected{% endif %}>Enabled</option>
                        <option value="0" {% if settings.get('enabled') == '0' %}selected{% endif %}>Disabled (Off)</option>
                    </select>
                </div>
            </div>

            <!-- Recipient -->
            <div class="form-row" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Recipient Email *</label>
                    <input type="email" id="set-email" value="{{ settings.get('recipient_email', '') }}" placeholder="kim@company.com" required>
                </div>
            </div>

            <!-- Frequency -->
            <div class="form-row">
                <div class="form-group">
                    <label>Frequency</label>
                    <select id="set-frequency" onchange="updateFrequencyOptions()">
                        <option value="daily" {% if settings.get('frequency') == 'daily' %}selected{% endif %}>Daily</option>
                        <option value="weekly" {% if settings.get('frequency') == 'weekly' %}selected{% endif %}>Weekly</option>
                        <option value="biweekly" {% if settings.get('frequency') == 'biweekly' %}selected{% endif %}>Bi-weekly</option>
                        <option value="monthly" {% if settings.get('frequency') == 'monthly' %}selected{% endif %}>Monthly</option>
                    </select>
                </div>
                <div class="form-group" id="day-group">
                    <label>Day of Week</label>
                    <select id="set-day">
                        <option value="1" {% if settings.get('day_of_week') == '1' %}selected{% endif %}>Monday</option>
                        <option value="2" {% if settings.get('day_of_week') == '2' %}selected{% endif %}>Tuesday</option>
                        <option value="3" {% if settings.get('day_of_week') == '3' %}selected{% endif %}>Wednesday</option>
                        <option value="4" {% if settings.get('day_of_week') == '4' %}selected{% endif %}>Thursday</option>
                        <option value="5" {% if settings.get('day_of_week') == '5' %}selected{% endif %}>Friday</option>
                        <option value="6" {% if settings.get('day_of_week') == '6' %}selected{% endif %}>Saturday</option>
                        <option value="0" {% if settings.get('day_of_week') == '0' %}selected{% endif %}>Sunday</option>
                    </select>
                </div>
            </div>

            <!-- Time -->
            <div class="form-row">
                <div class="form-group">
                    <label>Time of Day</label>
                    <input type="time" id="set-time" value="{{ settings.get('time_of_day', '08:00') }}">
                </div>
                <div class="form-group">
                    <label>Include</label>
                    <select id="set-scope" onchange="toggleFilter()">
                        <option value="all" {% if settings.get('include_scope') == 'all' %}selected{% endif %}>Everyone</option>
                        <option value="employee" {% if settings.get('include_scope') == 'employee' %}selected{% endif %}>Specific Employee</option>
                        <option value="project" {% if settings.get('include_scope') == 'project' %}selected{% endif %}>Specific Project</option>
                    </select>
                </div>
            </div>

            <!-- Filter (shown when scope is not "all") -->
            <div class="form-row" id="filter-row" style="display:none; grid-template-columns: 1fr;">
                <div class="form-group">
                    <label id="filter-label">Filter</label>
                    <select id="set-filter">
                        <option value="">Select...</option>
                        {% for e in employees %}
                        <option value="employee:{{ e.id }}" class="opt-employee" {% if settings.get('include_filter') == 'employee:' ~ e.id|string %}selected{% endif %}>{{ e.first_name }}</option>
                        {% endfor %}
                        {% for p in projects %}
                        <option value="project:{{ p.id }}" class="opt-project" {% if settings.get('include_filter') == 'project:' ~ p.id|string %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Save + Send Now -->
            <div style="display:flex; gap:8px; margin-top:16px;">
                <button type="submit" class="btn btn--primary">Save Settings</button>
                <button type="button" class="btn btn--secondary" onclick="sendNow()">Send Report Now</button>
            </div>
            <div id="settings-msg" style="margin-top:10px;"></div>
        </form>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// ── Email Settings ──────────────────────

function updateFrequencyOptions() {
    var freq = document.getElementById('set-frequency').value;
    var dayGroup = document.getElementById('day-group');
    dayGroup.style.display = (freq === 'daily') ? 'none' : '';
}

function toggleFilter() {
    var scope = document.getElementById('set-scope').value;
    var filterRow = document.getElementById('filter-row');
    var filterLabel = document.getElementById('filter-label');
    filterRow.style.display = (scope === 'all') ? 'none' : '';

    var empOpts = document.querySelectorAll('.opt-employee');
    var projOpts = document.querySelectorAll('.opt-project');
    empOpts.forEach(function(o) { o.style.display = (scope === 'employee') ? '' : 'none'; });
    projOpts.forEach(function(o) { o.style.display = (scope === 'project') ? '' : 'none'; });
    filterLabel.textContent = scope === 'employee' ? 'Employee' : 'Project';
}

function saveSettings(e) {
    e.preventDefault();
    var data = {
        enabled: document.getElementById('set-enabled').value,
        recipient_email: document.getElementById('set-email').value,
        frequency: document.getElementById('set-frequency').value,
        day_of_week: document.getElementById('set-day').value,
        time_of_day: document.getElementById('set-time').value,
        include_scope: document.getElementById('set-scope').value,
        include_filter: document.getElementById('set-filter').value || '',
    };
    fetch('/api/settings', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data),
    })
    .then(function(resp) { return resp.json(); })
    .then(function(d) {
        var msg = document.getElementById('settings-msg');
        if (d.status === 'updated') {
            msg.innerHTML = '<span style="color:#16a34a;">Settings saved.</span>';
        } else {
            msg.innerHTML = '<span style="color:#dc2626;">' + (d.error || 'Failed to save') + '</span>';
        }
    });
}

function sendNow() {
    var msg = document.getElementById('settings-msg');
    msg.innerHTML = '<span style="color:#6b7280;">Sending report...</span>';
    fetch('/api/settings/send-now', { method: 'POST' })
    .then(function(resp) { return resp.json(); })
    .then(function(d) {
        if (d.status === 'sent') {
            msg.innerHTML = '<span style="color:#16a34a;">Report sent to ' + d.recipient + '</span>';
        } else {
            msg.innerHTML = '<span style="color:#dc2626;">' + (d.error || 'Failed to send') + '</span>';
        }
    });
}

// ── Project Management ──────────────────

function showAddProject() {
    document.getElementById('add-project-form').style.display = 'block';
    document.getElementById('proj-name').focus();
}

function hideAddProject() {
    document.getElementById('add-project-form').style.display = 'none';
    document.getElementById('proj-error').style.display = 'none';
}

function addProject(e) {
    e.preventDefault();
    var data = {
        name: document.getElementById('proj-name').value,
        project_code: document.getElementById('proj-code').value || undefined,
        address: document.getElementById('proj-address').value || undefined,
        city: document.getElementById('proj-city').value || undefined,
        state: document.getElementById('proj-state').value || undefined,
        status: document.getElementById('proj-status').value,
        start_date: document.getElementById('proj-start').value || undefined,
        end_date: document.getElementById('proj-end').value || undefined,
        notes: document.getElementById('proj-notes').value || undefined,
    };
    fetch('/api/projects', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data),
    })
    .then(function(resp) { return resp.json().then(function(d) { return {status: resp.status, data: d}; }); })
    .then(function(r) {
        if (r.status === 201) {
            location.reload();
        } else {
            var errEl = document.getElementById('proj-error');
            errEl.textContent = r.data.error || 'Failed to add project';
            errEl.style.display = 'block';
        }
    });
}

// Init visibility
updateFrequencyOptions();
toggleFilter();
</script>
{% endblock %}

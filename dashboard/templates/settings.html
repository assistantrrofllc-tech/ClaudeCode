{% extends "base.html" %}
{% set active_page = "settings" %}
{% block title %}CrewLedger — Settings{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Settings</h1>
</div>

<!-- Quick Links -->
<div class="settings-links">
    <a href="/employees" class="settings-link-card">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        <div>
            <strong>Employee Management</strong>
            <span>Add, edit, deactivate employees</span>
        </div>
    </a>
    <a href="/projects" class="settings-link-card">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
        <div>
            <strong>Project Management</strong>
            <span>Add, edit, manage projects</span>
        </div>
    </a>
</div>

<!-- Category Management -->
<section class="settings-section">
    <h2>Categories</h2>
    <div class="card" style="max-width: 640px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <span style="font-size:13px; color:#6b7280;">Manage receipt categories</span>
            <button class="btn btn--small btn--primary" onclick="showAddCategory()">Add Category</button>
        </div>
        <div id="add-cat-row" style="display:none; margin-bottom:12px;">
            <div style="display:flex; gap:8px; align-items:center;">
                <input type="text" id="new-cat-name" placeholder="Category name" style="flex:1; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                <button class="btn btn--small btn--primary" onclick="addCategory()">Save</button>
                <button class="btn btn--small btn--secondary" onclick="hideAddCategory()">Cancel</button>
            </div>
            <div id="add-cat-msg" style="margin-top:4px; font-size:12px;"></div>
        </div>
        <table class="line-items-table" id="categories-table">
            <thead><tr><th>Name</th><th>Status</th><th style="text-align:right;">Actions</th></tr></thead>
            <tbody id="categories-body">
                <tr><td colspan="3" class="text-muted">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</section>

<!-- Email Report Settings -->
<section class="settings-section">
    <h2>Email Reports</h2>
    <div class="card" style="max-width: 640px;">
        <form id="settings-form" onsubmit="saveSettings(event)">
            <!-- Enable/Disable -->
            <div class="form-row" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Email Reports</label>
                    <select id="set-enabled">
                        <option value="1" {% if settings.get('enabled') == '1' %}selected{% endif %}>Enabled</option>
                        <option value="0" {% if settings.get('enabled') == '0' %}selected{% endif %}>Disabled (Off)</option>
                    </select>
                </div>
            </div>

            <!-- Recipient -->
            <div class="form-row" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Recipient Email *</label>
                    <input type="email" id="set-email" value="{{ settings.get('recipient_email', '') }}" placeholder="accountant@company.com" required>
                </div>
            </div>

            <!-- Frequency -->
            <div class="form-row">
                <div class="form-group">
                    <label>Frequency</label>
                    <select id="set-frequency" onchange="updateFrequencyOptions()">
                        <option value="daily" {% if settings.get('frequency') == 'daily' %}selected{% endif %}>Daily</option>
                        <option value="weekly" {% if settings.get('frequency') == 'weekly' %}selected{% endif %}>Weekly</option>
                        <option value="biweekly" {% if settings.get('frequency') == 'biweekly' %}selected{% endif %}>Bi-weekly</option>
                        <option value="monthly" {% if settings.get('frequency') == 'monthly' %}selected{% endif %}>Monthly</option>
                    </select>
                </div>
                <div class="form-group" id="day-group">
                    <label>Day of Week</label>
                    <select id="set-day">
                        <option value="1" {% if settings.get('day_of_week') == '1' %}selected{% endif %}>Monday</option>
                        <option value="2" {% if settings.get('day_of_week') == '2' %}selected{% endif %}>Tuesday</option>
                        <option value="3" {% if settings.get('day_of_week') == '3' %}selected{% endif %}>Wednesday</option>
                        <option value="4" {% if settings.get('day_of_week') == '4' %}selected{% endif %}>Thursday</option>
                        <option value="5" {% if settings.get('day_of_week') == '5' %}selected{% endif %}>Friday</option>
                        <option value="6" {% if settings.get('day_of_week') == '6' %}selected{% endif %}>Saturday</option>
                        <option value="0" {% if settings.get('day_of_week') == '0' %}selected{% endif %}>Sunday</option>
                    </select>
                </div>
            </div>

            <!-- Time -->
            <div class="form-row">
                <div class="form-group">
                    <label>Time of Day</label>
                    <input type="time" id="set-time" value="{{ settings.get('time_of_day', '08:00') }}">
                </div>
                <div class="form-group">
                    <label>Include</label>
                    <select id="set-scope" onchange="toggleFilter()">
                        <option value="all" {% if settings.get('include_scope') == 'all' %}selected{% endif %}>Everyone</option>
                        <option value="employee" {% if settings.get('include_scope') == 'employee' %}selected{% endif %}>Specific Employee</option>
                        <option value="project" {% if settings.get('include_scope') == 'project' %}selected{% endif %}>Specific Project</option>
                    </select>
                </div>
            </div>

            <!-- Filter (shown when scope is not "all") -->
            <div class="form-row" id="filter-row" style="display:none; grid-template-columns: 1fr;">
                <div class="form-group">
                    <label id="filter-label">Filter</label>
                    <select id="set-filter">
                        <option value="">Select...</option>
                        {% for e in employees %}
                        <option value="employee:{{ e.id }}" class="opt-employee" {% if settings.get('include_filter') == 'employee:' ~ e.id|string %}selected{% endif %}>{{ e.first_name }}</option>
                        {% endfor %}
                        {% for p in projects %}
                        <option value="project:{{ p.id }}" class="opt-project" {% if settings.get('include_filter') == 'project:' ~ p.id|string %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Save + Send Now -->
            <div style="display:flex; gap:8px; margin-top:16px;">
                <button type="submit" class="btn btn--primary">Save Settings</button>
                <button type="button" class="btn btn--secondary" onclick="sendNow()">Send Report Now</button>
            </div>
            <div id="settings-msg" style="margin-top:10px;"></div>
        </form>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// ── Email Settings ──────────────────────

function updateFrequencyOptions() {
    var freq = document.getElementById('set-frequency').value;
    var dayGroup = document.getElementById('day-group');
    dayGroup.style.display = (freq === 'daily') ? 'none' : '';
}

function toggleFilter() {
    var scope = document.getElementById('set-scope').value;
    var filterRow = document.getElementById('filter-row');
    var filterLabel = document.getElementById('filter-label');
    filterRow.style.display = (scope === 'all') ? 'none' : '';

    var empOpts = document.querySelectorAll('.opt-employee');
    var projOpts = document.querySelectorAll('.opt-project');
    empOpts.forEach(function(o) { o.style.display = (scope === 'employee') ? '' : 'none'; });
    projOpts.forEach(function(o) { o.style.display = (scope === 'project') ? '' : 'none'; });
    filterLabel.textContent = scope === 'employee' ? 'Employee' : 'Project';
}

function saveSettings(e) {
    e.preventDefault();
    var data = {
        enabled: document.getElementById('set-enabled').value,
        recipient_email: document.getElementById('set-email').value,
        frequency: document.getElementById('set-frequency').value,
        day_of_week: document.getElementById('set-day').value,
        time_of_day: document.getElementById('set-time').value,
        include_scope: document.getElementById('set-scope').value,
        include_filter: document.getElementById('set-filter').value || '',
    };
    fetch('/api/settings', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data),
    })
    .then(function(resp) { return resp.json(); })
    .then(function(d) {
        var msg = document.getElementById('settings-msg');
        if (d.status === 'updated') {
            msg.innerHTML = '<span style="color:#16a34a;">Settings saved.</span>';
        } else {
            msg.innerHTML = '<span style="color:#dc2626;">' + (d.error || 'Failed to save') + '</span>';
        }
    });
}

function sendNow() {
    var msg = document.getElementById('settings-msg');
    msg.innerHTML = '<span style="color:#6b7280;">Sending report...</span>';
    fetch('/api/settings/send-now', { method: 'POST' })
    .then(function(resp) { return resp.json(); })
    .then(function(d) {
        if (d.status === 'sent') {
            msg.innerHTML = '<span style="color:#16a34a;">Report sent to ' + d.recipient + '</span>';
        } else {
            msg.innerHTML = '<span style="color:#dc2626;">' + (d.error || 'Failed to send') + '</span>';
        }
    });
}

// Init visibility
updateFrequencyOptions();
toggleFilter();

// ── Category Management ────────────────────
function loadCategories() {
    fetch('/api/categories')
        .then(function(r) { return r.json(); })
        .then(function(cats) {
            var tbody = document.getElementById('categories-body');
            if (!cats.length) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-muted">No categories found.</td></tr>';
                return;
            }
            var html = '';
            for (var i = 0; i < cats.length; i++) {
                var c = cats[i];
                var statusBadge = c.is_active
                    ? '<span class="badge badge--confirmed">Active</span>'
                    : '<span class="badge badge--flagged">Inactive</span>';
                var actions = '';
                actions += '<button class="btn btn--small btn--secondary" onclick="renameCategory(' + c.id + ', \'' + escapeAttr(c.name) + '\', ' + (c.receipt_count || 0) + ')" style="margin-right:4px;">Rename</button>';
                if (c.is_active) {
                    actions += '<button class="btn btn--small btn--danger" onclick="deactivateCategory(' + c.id + ')">Deactivate</button>';
                } else {
                    actions += '<button class="btn btn--small btn--success" onclick="activateCategory(' + c.id + ')">Activate</button>';
                }
                html += '<tr><td>' + escapeHtml(c.name) + '</td><td>' + statusBadge + '</td><td style="text-align:right;">' + actions + '</td></tr>';
            }
            tbody.innerHTML = html;
        });
}

function showAddCategory() {
    document.getElementById('add-cat-row').style.display = '';
    document.getElementById('new-cat-name').focus();
}

function hideAddCategory() {
    document.getElementById('add-cat-row').style.display = 'none';
    document.getElementById('new-cat-name').value = '';
    document.getElementById('add-cat-msg').innerHTML = '';
}

function addCategory() {
    var name = document.getElementById('new-cat-name').value.trim();
    var msg = document.getElementById('add-cat-msg');
    if (!name) { msg.innerHTML = '<span style="color:#dc2626;">Name is required.</span>'; return; }
    fetch('/api/categories', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name}),
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.id) {
            hideAddCategory();
            loadCategories();
            _cachedCategories = null; // bust cache for edit forms
        } else {
            msg.innerHTML = '<span style="color:#dc2626;">' + (d.error || 'Failed') + '</span>';
        }
    });
}

function renameCategory(id, currentName, receiptCount) {
    var warning = '';
    if (receiptCount > 0) {
        warning = receiptCount + ' receipt' + (receiptCount !== 1 ? 's' : '') + ' use this category \u2014 renaming will update all of them.\n\n';
    }
    var newName = prompt(warning + 'Rename "' + currentName + '" to:', currentName);
    if (!newName || newName.trim() === currentName) return;
    fetch('/api/categories/' + id, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: newName.trim()}),
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.status === 'updated') {
            loadCategories();
            _cachedCategories = null;
        } else {
            alert(d.error || 'Failed to rename');
        }
    });
}

function deactivateCategory(id) {
    if (!confirm('Deactivate this category? It will disappear from dropdowns but historical receipts keep their label.')) return;
    fetch('/api/categories/' + id + '/deactivate', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.status === 'deactivated') {
                loadCategories();
                _cachedCategories = null;
            } else {
                alert(d.error || 'Failed to deactivate');
            }
        });
}

function activateCategory(id) {
    fetch('/api/categories/' + id + '/activate', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.status === 'activated') {
                loadCategories();
                _cachedCategories = null;
            } else {
                alert(d.error || 'Failed to activate');
            }
        });
}

// escapeHtml/escapeAttr may already be in app.js — define local fallbacks
if (typeof escapeHtml === 'undefined') {
    function escapeHtml(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
}
if (typeof escapeAttr === 'undefined') {
    function escapeAttr(s) { if (!s) return ''; return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
}

loadCategories();
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}CrewLedger — Ledger{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Ledger</h1>
    <div class="header-actions">
        <button class="btn btn--secondary" onclick="printLedger()">Print</button>
        {% if can_export %}
        <div class="dropdown">
            <button class="btn btn--primary" onclick="toggleDropdown('export-menu')">Export</button>
            <div id="export-menu" class="dropdown-menu" style="display:none;">
                <a href="#" onclick="exportData('quickbooks'); return false;">QuickBooks CSV</a>
                <a href="#" onclick="exportData('csv'); return false;">Google Sheets CSV</a>
                <a href="#" onclick="exportData('excel'); return false;">Excel (.xlsx)</a>
            </div>
        </div>
        {% endif %}
        {% if can_edit %}
        <button class="btn btn--primary" onclick="openAddReceiptForm()">+ Add Receipt</button>
        {% endif %}
    </div>
</div>

<!-- Time Filter Buttons -->
<div class="filter-bar">
    <div class="time-filters">
        <button class="filter-btn active" data-period="all" onclick="setPeriod('all', this)">All</button>
        <button class="filter-btn" data-period="today" onclick="setPeriod('today', this)">Today</button>
        <button class="filter-btn" data-period="week" onclick="setPeriod('week', this)">This Week</button>
        <button class="filter-btn" data-period="month" onclick="setPeriod('month', this)">This Month</button>
        <button class="filter-btn" data-period="ytd" onclick="setPeriod('ytd', this)">YTD</button>
        <button class="filter-btn" data-period="custom" onclick="showCustomRange()">Custom</button>
        <button class="filter-toggle-btn" id="filter-toggle-btn" onclick="toggleFilters()">Filters</button>
    </div>
    <div id="custom-range" class="custom-range" style="display:none;">
        <input type="date" id="date-start">
        <span>to</span>
        <input type="date" id="date-end">
        <button class="btn btn--small btn--primary" onclick="applyCustomRange()">Apply</button>
    </div>
</div>

<!-- Sort & Filter Row -->
<div class="sort-row">
    <select id="sort-select" onchange="loadLedger()">
        <option value="date">Sort by Date</option>
        <option value="employee">Sort by Employee</option>
        <option value="vendor">Sort by Vendor</option>
        <option value="project">Sort by Project</option>
        <option value="amount">Sort by Amount</option>
        <option value="status">Sort by Status</option>
    </select>
    <select id="order-select" onchange="loadLedger()">
        <option value="desc">Newest First</option>
        <option value="asc">Oldest First</option>
    </select>
    <select id="status-filter" onchange="loadLedger()">
        <option value="">All Statuses</option>
        <option value="confirmed">Confirmed</option>
        <option value="pending">Pending</option>
        <option value="flagged">Flagged</option>
    </select>
    <label class="toggle-label" style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;">
        <input type="checkbox" id="show-hidden" onchange="loadLedger()"> Show Hidden
    </label>
    <select id="employee-filter" onchange="loadLedger()">
        <option value="">All Employees</option>
        {% for e in employees %}
        <option value="{{ e.id }}">{{ e.first_name }}</option>
        {% endfor %}
    </select>
    <select id="project-filter" onchange="loadLedger()">
        <option value="">All Projects</option>
        {% for p in projects %}
        <option value="{{ p.id }}">{{ p.name }}</option>
        {% endfor %}
    </select>
</div>

<!-- Totals Bar -->
<div class="totals-bar" id="totals-bar">
    <span id="total-count">0 transactions</span>
    <span id="total-amount">$0.00</span>
</div>

<!-- Transaction Table -->
<div class="card ledger-card">
    <table class="data-table ledger-table" id="ledger-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Employee</th>
                <th>Vendor</th>
                <th>Project</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Notes</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="ledger-body">
            <tr><td colspan="9" class="loading">Loading...</td></tr>
        </tbody>
    </table>
</div>

<!-- Status Popover -->
<div id="status-popover" class="status-popover" style="display:none;">
    <button class="sp-confirm" onclick="changeReceiptStatus('confirmed')">Confirm</button>
    <button class="sp-flag" onclick="changeReceiptStatus('flagged')">Flag</button>
    <button class="sp-delete" onclick="statusPopoverDelete()">Delete</button>
</div>

<!-- Print-only view -->
<div id="print-view" class="print-only">
    <div class="print-header">
        <h1>CrewLedger Transaction Report</h1>
        <p>Roofing & Renovations of Florida LLC</p>
        <p id="print-date-range"></p>
        <p id="print-generated"></p>
    </div>
    <table class="print-table" id="print-table">
        <thead>
            <tr><th>Date</th><th>Employee</th><th>Vendor</th><th>Project</th><th>Category</th><th>Amount</th><th>Status</th><th>Notes</th></tr>
        </thead>
        <tbody id="print-body"></tbody>
        <tfoot id="print-foot"></tfoot>
    </table>
</div>
{% endblock %}

{% block pre_scripts %}
<script>
var CAN_EDIT = {{ can_edit | tojson }};
var USER_ROLE = {{ user_role | tojson }};
</script>
{% endblock %}

{% block scripts %}
<script>
var currentPeriod = 'all';
var currentData = [];

function setPeriod(period, btn) {
    currentPeriod = period;
    document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
    if (btn) btn.classList.add('active');
    if (period !== 'custom') {
        document.getElementById('custom-range').style.display = 'none';
    }
    loadLedger();
}

function showCustomRange() {
    document.getElementById('custom-range').style.display = 'flex';
    document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
    document.querySelector('[data-period="custom"]').classList.add('active');
}

function applyCustomRange() {
    currentPeriod = 'custom';
    loadLedger();
}

function loadLedger() {
    var params = new URLSearchParams();
    if (currentPeriod === 'custom') {
        var s = document.getElementById('date-start').value;
        var e = document.getElementById('date-end').value;
        if (s) params.set('start', s);
        if (e) params.set('end', e);
    } else if (currentPeriod !== 'all') {
        params.set('period', currentPeriod);
    }

    var sort = document.getElementById('sort-select').value;
    var order = document.getElementById('order-select').value;
    var status = document.getElementById('status-filter').value;
    var emp = document.getElementById('employee-filter').value;
    var proj = document.getElementById('project-filter').value;

    var showHidden = document.getElementById('show-hidden').checked;

    params.set('sort', sort);
    params.set('order', order);
    if (status) params.set('status', status);
    if (emp) params.set('employee', emp);
    if (proj) params.set('project', proj);
    if (showHidden) params.set('include_hidden', '1');

    fetch('/api/receipts?' + params.toString())
        .then(function(r) { return r.json(); })
        .then(function(data) {
            currentData = data;
            _receiptNavList = data.map(function(r) { return r.id; });
            renderLedger(data);
            updateTotals(data);
        });
}

function renderLedger(data) {
    var body = document.getElementById('ledger-body');
    if (data.length === 0) {
        body.innerHTML = '<tr><td colspan="9" class="loading">No transactions found</td></tr>';
        return;
    }
    var isMobile = window.innerWidth <= 768;
    var html = '';
    for (var i = 0; i < data.length; i++) {
        var r = data[i];
        html += '<tr onclick="openReceiptModal(' + r.id + ')">';
        html += '<td>' + (isMobile ? formatDateShort(r.purchase_date || r.created_at) : formatDate(r.purchase_date || r.created_at)) + '</td>';
        html += '<td>' + escapeHtml(r.employee_name || '?') + '</td>';
        html += '<td>' + escapeHtml(r.vendor_name || 'Unknown') + '</td>';
        html += '<td>' + escapeHtml(r.project_name || r.matched_project_name || '—') + '</td>';
        html += '<td><span class="badge badge--cat">' + escapeHtml(r.category || '—') + '</span></td>';
        html += '<td class="cell-amount">' + formatMoney(r.total) + '</td>';
        if (CAN_EDIT) {
            html += '<td><span class="badge badge--' + (r.status || '') + ' badge-action" onclick="event.stopPropagation(); openStatusPopover(' + r.id + ', this)">' + (r.status || '') + '</span></td>';
        } else {
            html += '<td><span class="badge badge--' + (r.status || '') + '">' + (r.status || '') + '</span></td>';
        }
        html += '<td class="cell-notes">' + escapeHtml(r.notes || '') + '</td>';
        html += '<td class="cell-actions">';
        if (CAN_EDIT) {
            html += '<button class="row-action-btn row-action-btn--edit" onclick="event.stopPropagation(); quickEditReceipt(' + r.id + ')" title="Quick edit">';
            html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>';
            html += '</button>';
            html += '<button class="row-action-btn row-action-btn--delete" onclick="event.stopPropagation(); deleteReceipt(' + r.id + ')" title="Delete">';
            html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>';
            html += '</button>';
        }
        html += '</td>';
        html += '</tr>';
    }
    body.innerHTML = html;
}

function updateTotals(data) {
    var total = 0;
    for (var i = 0; i < data.length; i++) {
        total += (data[i].total || 0);
    }
    document.getElementById('total-count').textContent = data.length + ' transaction' + (data.length !== 1 ? 's' : '');
    document.getElementById('total-amount').textContent = formatMoney(total);
}

function getFilterParams() {
    var params = new URLSearchParams();
    if (currentPeriod === 'custom') {
        var s = document.getElementById('date-start').value;
        var e = document.getElementById('date-end').value;
        if (s) params.set('start', s);
        if (e) params.set('end', e);
    } else if (currentPeriod !== 'all') {
        params.set('period', currentPeriod);
    }
    var status = document.getElementById('status-filter').value;
    var emp = document.getElementById('employee-filter').value;
    var proj = document.getElementById('project-filter').value;
    if (status) params.set('status', status);
    if (emp) params.set('employee', emp);
    if (proj) params.set('project', proj);
    params.set('sort', document.getElementById('sort-select').value);
    params.set('order', document.getElementById('order-select').value);
    return params;
}

// ── Export ──────────────────────────────

function exportData(format) {
    var params = getFilterParams();
    params.set('format', format);
    window.location.href = '/api/receipts/export?' + params.toString();
    toggleDropdown('export-menu');
}

function toggleDropdown(id) {
    var el = document.getElementById(id);
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

// Close dropdown on outside click
document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-menu').forEach(function(m) { m.style.display = 'none'; });
    }
});

// ── Print ──────────────────────────────

function printLedger() {
    var printBody = document.getElementById('print-body');
    var html = '';
    var total = 0;
    for (var i = 0; i < currentData.length; i++) {
        var r = currentData[i];
        total += (r.total || 0);
        html += '<tr>';
        html += '<td>' + (r.purchase_date || '—') + '</td>';
        html += '<td>' + escapeHtml(r.employee_name || '') + '</td>';
        html += '<td>' + escapeHtml(r.vendor_name || '') + '</td>';
        html += '<td>' + escapeHtml(r.project_name || r.matched_project_name || '') + '</td>';
        html += '<td style="text-align:right">' + formatMoney(r.total) + '</td>';
        html += '<td>' + (r.status || '') + '</td>';
        html += '<td>' + escapeHtml(r.notes || '') + '</td>';
        html += '</tr>';
    }
    printBody.innerHTML = html;
    document.getElementById('print-foot').innerHTML =
        '<tr><td colspan="4" style="text-align:right;font-weight:bold">Total:</td>' +
        '<td style="text-align:right;font-weight:bold">' + formatMoney(total) + '</td><td colspan="2"></td></tr>';

    document.getElementById('print-date-range').textContent = 'Period: ' + currentPeriod;
    document.getElementById('print-generated').textContent = 'Generated: ' + new Date().toLocaleDateString();
    window.print();
}

// ── Status Popover ────────────────────────

var _statusPopoverReceiptId = null;

function openStatusPopover(receiptId, badgeEl) {
    _statusPopoverReceiptId = receiptId;
    var popover = document.getElementById('status-popover');
    var rect = badgeEl.getBoundingClientRect();
    popover.style.top = (rect.bottom + 4) + 'px';
    popover.style.left = rect.left + 'px';
    popover.style.display = 'block';
}

function closeStatusPopover() {
    document.getElementById('status-popover').style.display = 'none';
    _statusPopoverReceiptId = null;
}

function changeReceiptStatus(newStatus) {
    var receiptId = _statusPopoverReceiptId;
    if (!receiptId) return;
    closeStatusPopover();

    fetch('/api/receipts/' + receiptId + '/edit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: newStatus}),
    })
    .then(function(resp) { return resp.json(); })
    .then(function(d) {
        if (d.status === 'updated') {
            loadLedger();
        } else {
            alert(d.error || 'Failed to update status');
        }
    });
}

function statusPopoverDelete() {
    var receiptId = _statusPopoverReceiptId;
    closeStatusPopover();
    if (receiptId) deleteReceipt(receiptId);
}

// Close popover on outside click
document.addEventListener('click', function(e) {
    if (!e.target.closest('.status-popover') && !e.target.closest('.badge-action')) {
        closeStatusPopover();
    }
});

// ── Quick Edit (pencil icon) ──────────────

function quickEditReceipt(receiptId) {
    _autoEditOnLoad = true;
    openReceiptModal(receiptId);
}

// ── Add Receipt ───────────────────────────

var _addReceiptEmployees = {{ employees | tojson }};
var _addReceiptProjects = {{ projects | tojson }};
var _addReceiptCategories = {{ categories | tojson }};

function openAddReceiptForm() {
    var modal = document.getElementById('receipt-modal');
    var img = document.getElementById('modal-receipt-image');
    var details = document.getElementById('modal-receipt-details');
    var footer = document.getElementById('modal-receipt-footer');

    _currentReceiptId = null;
    _currentReceiptData = null;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    img.style.display = 'none';

    var html = '<h3>Add Receipt</h3>';
    html += '<div class="edit-form" style="margin-top:0;border:none;background:none;padding:0;">';
    html += '<div class="form-row">';
    html += '<div class="form-group"><label>Employee</label><select id="add-employee">';
    html += '<option value="">Select employee...</option>';
    for (var i = 0; i < _addReceiptEmployees.length; i++) {
        var e = _addReceiptEmployees[i];
        html += '<option value="' + e.id + '">' + escapeHtml(e.first_name) + '</option>';
    }
    html += '</select></div>';
    html += '<div class="form-group"><label>Vendor</label><input type="text" id="add-vendor" placeholder="Store name"></div>';
    html += '</div>';

    html += '<div class="form-row">';
    html += '<div class="form-group"><label>Date</label><input type="date" id="add-date" value="' + new Date().toISOString().split('T')[0] + '"></div>';
    html += '<div class="form-group"><label>Payment Method</label><input type="text" id="add-payment" placeholder="e.g. Company Card"></div>';
    html += '</div>';

    html += '<div class="form-row form-row--3col">';
    html += '<div class="form-group"><label>Subtotal</label><input type="number" step="0.01" id="add-subtotal" placeholder="0.00"></div>';
    html += '<div class="form-group"><label>Tax</label><input type="number" step="0.01" id="add-tax" placeholder="0.00" value="0"></div>';
    html += '<div class="form-group"><label>Total</label><input type="number" step="0.01" id="add-total" placeholder="0.00"></div>';
    html += '</div>';

    html += '<div class="form-row">';
    html += '<div class="form-group"><label>Project</label><select id="add-project">';
    html += '<option value="">None</option>';
    for (var j = 0; j < _addReceiptProjects.length; j++) {
        var p = _addReceiptProjects[j];
        html += '<option value="' + p.id + '">' + escapeHtml(p.name) + '</option>';
    }
    html += '</select></div>';
    html += '<div class="form-group"><label>Category</label><select id="add-category">';
    html += '<option value="">None</option>';
    for (var k = 0; k < _addReceiptCategories.length; k++) {
        var c = _addReceiptCategories[k];
        html += '<option value="' + c.id + '">' + escapeHtml(c.name) + '</option>';
    }
    html += '</select></div>';
    html += '</div>';

    html += '<div class="form-group" style="margin-bottom:0;"><label>Notes</label>';
    html += '<textarea id="add-notes" class="notes-input" placeholder="Optional notes..."></textarea>';
    html += '</div>';
    html += '</div>';

    details.innerHTML = html;

    if (footer) {
        footer.innerHTML = '<button class="btn btn--small btn--primary" onclick="saveNewReceipt()">Save Receipt</button>'
            + ' <button class="btn btn--small btn--secondary" onclick="closeReceiptModal()">Cancel</button>'
            + ' <span id="add-receipt-msg" style="margin-left:8px;font-size:12px;"></span>';
    }

    // Auto-calc total from subtotal + tax
    var subEl = document.getElementById('add-subtotal');
    var taxEl = document.getElementById('add-tax');
    var totEl = document.getElementById('add-total');
    function autoTotal() {
        var s = parseFloat(subEl.value) || 0;
        var t = parseFloat(taxEl.value) || 0;
        if (s > 0) totEl.value = (s + t).toFixed(2);
    }
    subEl.addEventListener('input', autoTotal);
    taxEl.addEventListener('input', autoTotal);
}

function saveNewReceipt() {
    var msg = document.getElementById('add-receipt-msg');
    var empId = document.getElementById('add-employee').value;
    var vendor = document.getElementById('add-vendor').value.trim();
    var total = parseFloat(document.getElementById('add-total').value);

    if (!empId) { msg.innerHTML = '<span style="color:#dc2626;">Select an employee</span>'; return; }
    if (!vendor) { msg.innerHTML = '<span style="color:#dc2626;">Enter a vendor name</span>'; return; }
    if (!total || total <= 0) { msg.innerHTML = '<span style="color:#dc2626;">Enter a valid total</span>'; return; }

    msg.innerHTML = '<span style="color:#6b7280;">Saving...</span>';

    var payload = {
        employee_id: parseInt(empId, 10),
        vendor_name: vendor,
        purchase_date: document.getElementById('add-date').value,
        subtotal: parseFloat(document.getElementById('add-subtotal').value) || 0,
        tax: parseFloat(document.getElementById('add-tax').value) || 0,
        total: total,
        payment_method: document.getElementById('add-payment').value.trim(),
        notes: document.getElementById('add-notes').value.trim(),
    };

    var projId = document.getElementById('add-project').value;
    if (projId) payload.project_id = parseInt(projId, 10);

    var catId = document.getElementById('add-category').value;
    if (catId) payload.category_id = parseInt(catId, 10);

    fetch('/api/receipts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
    })
    .then(function(resp) { return resp.json(); })
    .then(function(d) {
        if (d.status === 'created') {
            msg.innerHTML = '<span style="color:#16a34a;">Receipt added!</span>';
            setTimeout(function() { closeReceiptModal(); loadLedger(); }, 600);
        } else {
            msg.innerHTML = '<span style="color:#dc2626;">' + (d.error || 'Failed') + '</span>';
        }
    });
}

function formatDateShort(dateStr) {
    if (!dateStr) return '—';
    var parts = dateStr.split('-');
    if (parts.length === 3) {
        return parts[1] + '/' + parts[2] + '/' + parts[0].slice(-2);
    }
    return dateStr;
}

// Apply URL params as initial filters on page load
(function() {
    var urlParams = new URLSearchParams(window.location.search);
    var period = urlParams.get('period');
    var project = urlParams.get('project');

    if (period && ['today', 'week', 'month', 'ytd'].indexOf(period) >= 0) {
        currentPeriod = period;
        document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
        var btn = document.querySelector('[data-period="' + period + '"]');
        if (btn) btn.classList.add('active');
    }
    if (project) {
        var projSelect = document.getElementById('project-filter');
        if (projSelect) projSelect.value = project;
    }
})();

// Load on page ready
loadLedger();
</script>
{% endblock %}
